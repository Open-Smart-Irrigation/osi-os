pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    stages {
        stage('1. Verify Build Tools') {
            steps {
                sh '''#!/bin/bash
                    echo "=== Verifying Build Tools ==="

                    if ! command -v node > /dev/null 2>&1; then
                        echo "❌ Node.js is not installed"
                        exit 1
                    fi

                    if ! command -v npm > /dev/null 2>&1; then
                        echo "❌ npm is not installed"
                        exit 1
                    fi

                    if ! command -v zip > /dev/null 2>&1; then
                        echo "❌ zip is not installed"
                        exit 1
                    fi

                    echo "✓ Node version: $(node --version)"
                    echo "✓ npm version: $(npm --version)"
                    echo "✓ Build tools ready"
                '''
            }
        }

        stage('2. Install Dependencies') {
            steps {
                sh '''#!/bin/bash
                    set -e
                    cd ${WORKSPACE}/web/react-gui
                    echo "=== Installing npm dependencies ==="
                    npm install
                    echo "✓ Dependencies installed successfully"
                '''
            }
        }

        stage('3. Build GUI') {
            steps {
                sh '''#!/bin/bash
                    set -e
                    cd ${WORKSPACE}/web/react-gui
                    echo "=== Building Open Smart Irrigation GUI ==="
                    npm run build

                    # Verify build output
                    if [ ! -f "dist/index.html" ]; then
                        echo "❌ Build failed - index.html not found"
                        exit 1
                    fi

                    echo "✓ GUI built successfully"
                    echo "Build contents:"
                    ls -lh dist/
                '''
            }
        }

        stage('4. Package GUI') {
            steps {
                sh '''#!/bin/bash
                    set -e
                    cd ${WORKSPACE}/web/react-gui

                    echo "=== Creating ZIP archive ==="

                    # Create a clean archive directory
                    rm -rf archive
                    mkdir -p archive

                    # Create timestamp for filename
                    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                    BUILD_NUM=${BUILD_NUMBER:-0}
                    ZIP_NAME="osi-gui-${BUILD_NUM}-${TIMESTAMP}.zip"

                    # Create zip from dist directory
                    cd dist
                    zip -r "../archive/${ZIP_NAME}" ./*
                    cd ..

                    # Verify zip was created
                    if [ ! -f "archive/${ZIP_NAME}" ]; then
                        echo "❌ Failed to create ZIP archive"
                        exit 1
                    fi

                    ZIP_SIZE=$(du -h "archive/${ZIP_NAME}" | cut -f1)
                    echo "✓ Created ${ZIP_NAME} (${ZIP_SIZE})"

                    # Create a 'latest' symlink for convenience
                    cd archive
                    ln -sf "${ZIP_NAME}" osi-gui-latest.zip
                    ls -lh
                '''
            }
        }

        stage('5. Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: 'web/react-gui/archive/*.zip', fingerprint: true
                echo '✓ GUI build archived successfully and ready for download'
            }
        }
    }

    post {
        success {
            echo '✓ GUI build completed successfully!'
            echo 'Download the ZIP file from the build artifacts.'
        }
        failure {
            echo '❌ GUI build failed! Check the console output for details.'
        }
        always {
            // Clean up build artifacts but keep the archive
            sh '''#!/bin/bash
                echo "=== Cleaning up build files ==="
                cd ${WORKSPACE}/web/react-gui
                rm -rf dist node_modules
                echo "✓ Cleanup complete (archive preserved)"
            '''
        }
    }
}
