pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '2'))
        timestamps()
    }

    stages {
        stage('1. Verify Build Tools') {
            steps {
                sh '''#!/bin/bash
                    echo "=== Verifying Build Tools ==="

                    if ! command -v node > /dev/null 2>&1; then
                        echo "❌ Node.js is not installed"
                        exit 1
                    fi

                    if ! command -v npm > /dev/null 2>&1; then
                        echo "❌ npm is not installed"
                        exit 1
                    fi

                    if ! command -v zip > /dev/null 2>&1; then
                        echo "❌ zip is not installed"
                        exit 1
                    fi

                    echo "✓ Node version: $(node --version)"
                    echo "✓ npm version: $(npm --version)"
                    echo "✓ Build tools ready"
                '''
            }
        }

        stage('2. Install Dependencies') {
            steps {
                sh '''#!/bin/bash
                    set -e
                    cd "${WORKSPACE}/web/react-gui"
                    echo "=== Installing npm dependencies ==="
                    npm install
                    echo "✓ Dependencies installed successfully"
                '''
            }
        }

        stage('3. Build GUI') {
            steps {
                sh '''#!/bin/bash
                    set -e
                    cd "${WORKSPACE}/web/react-gui"
                    echo "=== Building Open Smart Irrigation GUI ==="
                    npm run build

                    # Verify build output
                    if [ ! -f "build/index.html" ]; then
                        echo "❌ Build failed - index.html not found"
                        exit 1
                    fi

                    echo "✓ GUI built successfully"
                    echo "Build contents:"
                    ls -lh build/
                '''
            }
        }

        stage('4. Package GUI') {
            steps {
                sh '''#!/bin/bash
                    set -e
                    cd "${WORKSPACE}/web/react-gui"

                    echo "=== Creating ZIP archive ==="

                    # Create a clean archive directory
                    rm -rf archive
                    mkdir -p archive/gui

                    # Copy build contents to archive
                    echo "Adding GUI files..."
                    cp -r build/* archive/gui/

                    # Add farming database
                    echo "Adding farming database..."
                    if [ -f "farming.db" ]; then
                        cp farming.db archive/gui/
                        echo "✓ farming.db included"
                    else
                        echo "⚠ farming.db not found, skipping"
                    fi

                    # Create zip archive
                    cd archive
                    zip -r "osi-gui.zip" gui/*
                    cd ..

                    # Clean up temporary gui directory
                    rm -rf archive/gui

                    # Verify zip was created
                    if [ ! -f "archive/osi-gui.zip" ]; then
                        echo "❌ Failed to create ZIP archive"
                        exit 1
                    fi

                    ZIP_SIZE=$(du -h "archive/osi-gui.zip" | cut -f1)
                    echo "✓ Created osi-gui.zip (${ZIP_SIZE})"
                    echo "Contents:"
                    unzip -l "archive/osi-gui.zip" | head -20
                '''
            }
        }

        stage('5. Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: 'web/react-gui/archive/osi-gui.zip', fingerprint: true
                echo '✓ GUI build archived successfully and ready for download'
            }
        }
    }

    post {
        success {
            echo '✓ GUI build completed successfully!'
            echo 'Download the ZIP file from the build artifacts.'
        }
        failure {
            echo '❌ GUI build failed! Check the console output for details.'
        }
        always {
            // Clean up build artifacts but keep the archive
            sh '''#!/bin/bash
                echo "=== Cleaning up build files ==="
                cd "${WORKSPACE}/web/react-gui"
                rm -rf build node_modules
                echo "✓ Cleanup complete (archive preserved)"
            '''
        }
    }
}
